---
// src/components/LocationSidebar.astro
const { post } = Astro.props;
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="bg-white/65 backdrop-blur-xl rounded-[32px] p-6
            shadow-[0_20px_60px_rgba(255,182,193,0.35)]
            border border-white/70
            flex flex-col gap-6 w-full sticky top-24">  
 <div class="relative w-full aspect-square rounded-2xl
            bg-white/70 overflow-hidden
            border border-white/70
            shadow-inner group">
    <div id="mini-map" class="w-full h-full z-10"></div>
    
    <div id="distance-badge"class="hidden absolute top-3 right-3 z-[1000]
       bg-white text-slate-800
       px-3 py-1.5 rounded-xl font-semibold text-[11px]
       shadow-lg border border-white/70">
      <span id="distance-value">0</span> KM dari Anda
    </div>
  </div>

  <div class="space-y-2">
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-slate-800 font-noto-serif">Location Details</h3>
       <span class="text-xs bg-white/80 text-amber-500 px-2.5 py-1 rounded-lg border border-white/70 font-semibold shadow-sm">
            â˜… {post.rating || '0.0'}
        </span>
    </div>
   <p class="text-sm text-slate-600 leading-relaxed italic line-clamp-2">
      {post.lokasi || "Alamat tidak tersedia"}
    </p>
    <p class="text-[11px] text-slate-500 font-semibold uppercase tracking-wider">
        {post.kotakabupaten}, {post.provinsi}
    </p>
  </div>

 <a 
  href={`/travelmap?lat=${post.latitude}&lng=${post.longitude}&name=${encodeURIComponent(post.dtw)}`}
 class="flex items-center justify-center gap-2 w-full py-4
       bg-slate-800 hover:bg-slate-900
       text-white rounded-2xl font-bold text-sm
       transition-all shadow-lg shadow-slate-400/30 active:scale-95 z-20">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
  </svg>
  Lihat Rute di Travel Map
</a>

  <div class="grid grid-cols-2 border-t border-slate-800 pt-6">
    <div class="text-center border-r border-slate-800">
      <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Latitude</p>
      <p class="text-xs font-mono font-bold text-emerald-400">{post.latitude}</p>
    </div>
    <div class="text-center">
      <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Longitude</p>
      <p class="text-xs font-mono font-bold text-emerald-400">{post.longitude}</p>
    </div>
  </div>
</div>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script is:inline define:vars={{ destLat: post.latitude, destLng: post.longitude }}>
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function initSidebarMap() {
    const target = [parseFloat(destLat), parseFloat(destLng)];
    const map = L.map('mini-map', { zoomControl: false, attributionControl: false }).setView(target, 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const destIcon = L.divIcon({
        className: 'custom-icon',
        html: `<div class="w-4 h-4 bg-emerald-500 border-2 border-white rounded-full shadow-[0_0_10px_rgba(16,185,129,0.8)] animate-pulse"></div>`,
        iconSize: [16, 16]
    });
    L.marker(target, { icon: destIcon }).addTo(map);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const dist = getDistance(userLat, userLng, target[0], target[1]);
            
            const badge = document.getElementById('distance-badge');
            const value = document.getElementById('distance-value');
            if (badge && value) {
                value.innerText = dist.toFixed(1);
                badge.classList.remove('hidden');
            }
        });
    }
  }
  initSidebarMap();
</script>

<style>
    #mini-map { background: #0f172a; }
    .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); opacity: 0.6; }
</style>