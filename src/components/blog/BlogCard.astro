---
import { Image } from "astro:assets";
import SlideCard from "@/components/slide/SlideCard.astro";
import sql from "@/lib/db"; // Import koneksi DB Anda

// Ambil data destinasi dari DB untuk dijadikan 'Slide'
const locations = await sql`
  SELECT id, dtw as title, author, deskripsi_lengkap as description, 
         tags, tanggal as "pubDate" 
  FROM lokasi_wisata 
  ORDER BY tanggal DESC
`;

// Map data DB agar sesuai dengan Interface Slide di SlideCard
const slides = locations.map((loc) => ({
  id: loc.id,
  title: loc.title,
  author: loc.author,
  description: loc.description,
  tags: loc.tags,
  pubDate: new Date(loc.pubDate),
  theme: "black", // Default theme untuk slide
  transition: "slide",
}));

export interface Blog {
  id: string;
  title: string;
  rating?: number;
  totalReviews?: number; // â† TAMBAHKAN INI
  href?: string;
  author?: string;
  pubDate: Date | string;
  description?: string;
  image?: string;
  tags?: string[];
  icon?: string;
  location?: string;
  showExtraDetails?: boolean;
  kategori_akses?: "hidden" | "non-hidden";
}

interface Props {
  blog: Blog;
}

const { blog } = Astro.props;
const origin = Astro.url.origin;

const formattedRating = (blog.rating || 0).toLocaleString("id-ID", {
  minimumFractionDigits: 1,
  maximumFractionDigits: 1,
});

const hasReviews = blog.totalReviews && blog.totalReviews > 0;

const url = `${origin}/blogs/${blog.id}`;
const isHiddenGem = blog.kategori_akses === "hidden";

function getCategoryColor(blogId: string = "default") {
  const gradients = [
    "from-emerald-400/10 to-emerald-400/20",
    "from-amber-100 to-amber-200",
    "from-gray-100 to-gray-200",
    "from-blue-100 to-blue-200",
  ];
  const idStr = String(blogId);
  const sum = idStr
    .split("")
    .reduce((acc, char) => acc + char.charCodeAt(0), 0);
  const index = sum % gradients.length;
  return gradients[index];
}

const formatDate = (date: Date | string) => {
  const d = typeof date === "string" ? new Date(date) : date;
  return d.toLocaleDateString("id-ID", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<style>
  @keyframes shine {
    0% { transform: translateX(-100%) skewX(-15deg); }
    100% { transform: translateX(250%) skewX(-15deg); }
  }
  .animate-shine {
    animation: shine 3s infinite linear;
  }
  .glow-hidden {
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
    border-color: rgba(16, 185, 129, 0.6);
  }
</style>

<div
  class={`relative overflow-hidden pt-0 gap-0 w-full flex flex-col cursor-pointer transition-all duration-300 hover:-translate-y-1 rounded-xl
    ${isHiddenGem 
      ? 'bg-slate-900 glow-hidden' 
      : 'bg-slate-900/50 border border-slate-700 hover:border-emerald-500/50 hover:shadow-lg hover:shadow-emerald-500/10'
    }`}
>
  {/* Lapisan kilau hanya aktif jika Hidden */}
  {isHiddenGem && (
    <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden">
      <div class="w-1/2 h-full absolute top-0 left-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shine"></div>
    </div>
  )}

  <a href={`/blogs/${blog.id}`} class="flex flex-col flex-grow relative z-10">
    <header class="p-0 gap-0">
      <div class="aspect-video w-full bg-slate-800 relative group overflow-hidden">
        {/* Badge Hidden Gem */}
        {isHiddenGem && (
          <div class="absolute top-3 left-3 z-30 flex items-center gap-1 rounded-lg bg-emerald-500 px-2.5 py-1 text-[10px] font-black text-slate-900 shadow-xl border border-emerald-400 uppercase tracking-tighter">
            ðŸ’Ž Hidden Gem
          </div>
        )}

      <div class="absolute top-3 right-3 z-30 flex items-center gap-2 rounded-xl 
        bg-slate-900/80 backdrop-blur-md 
        px-3 py-1.5 text-[11px] font-semibold text-amber-300
        shadow-lg border border-amber-400/30">

          <span class="text-amber-400 text-[13px]">â˜…</span>

          <span>{formattedRating}</span>

          {hasReviews && (
            <span class="text-slate-400 text-[10px] font-medium">
              ({blog.totalReviews})
            </span>
          )}
        </div>


        {/* Image Handling */}
        {blog.image ? (
          <Image
            src={blog.image}
            alt={blog.title}
            width={800}
            height={450}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
          />
        ) : (
          <div class="flex h-full items-center justify-center">
            <div class={`h-full w-full bg-gradient-to-br ${getCategoryColor(blog.id)}`} />
          </div>
        )}
      </div>
    </header>

    <div class="p-4 flex flex-col flex-grow">
      <h3 class={`mt-1 line-clamp-2 font-noto-serif text-xl font-bold transition-colors ${isHiddenGem ? 'text-emerald-400' : 'text-slate-100 group-hover:text-emerald-400'}`}>
        {blog.title}
      </h3>

      {blog.location && (
        <p class="text-[11px] text-emerald-400 font-medium mt-1.5 flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
          </svg>
          <span class="truncate">{blog.location}</span>
        </p>
      )}

      <p class="mt-3 line-clamp-2 text-sm text-slate-400 leading-relaxed">
        {blog.description || "Jelajahi keindahan tersembunyi di lokasi ini..."}
      </p>

      {blog.showExtraDetails && (
        <div class="mt-5 h-24 w-full rounded-xl bg-slate-800/50 border border-slate-700 overflow-hidden relative">
          <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-3 h-3 bg-emerald-500 rounded-full shadow-[0_0_12px_rgba(16,185,129,0.7)] animate-pulse"></div>
          </div>
        </div>
      )}
    </div>

    <footer class="p-4 pt-0">
      <div class="flex items-center justify-between border-t border-slate-800 pt-4">
        <div class="text-[11px] text-slate-500 font-medium uppercase tracking-wider">
          {formatDate(blog.pubDate)}
        </div>
        <div class="text-[11px] text-slate-500 font-medium uppercase tracking-wider italic">
          Oleh {blog.author || 'Admin'}
        </div>
      </div>
    </footer>
  </a>

  <div class="p-4 pt-0 relative z-30">
    <div class="flex items-center justify-between gap-4">
      {blog.showExtraDetails ? (
        <a 
          href={`/blogs/${blog.id}`} 
          class={`flex-grow py-3 text-center rounded-xl font-bold text-xs tracking-widest transition-all shadow-lg active:scale-95
            ${isHiddenGem ? 'bg-emerald-400 text-slate-950 hover:bg-emerald-300' : 'bg-slate-800 text-white hover:bg-slate-700'}`}
        >
          VIEW DETAILS
        </a>
      ) : (
        <a href={`/blogs/${blog.id}`} class="text-xs font-bold text-emerald-400 hover:text-emerald-300 transition-colors flex items-center gap-1">
          READ MORE
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </a>
      )}
      
    </div>
  </div>
</div>