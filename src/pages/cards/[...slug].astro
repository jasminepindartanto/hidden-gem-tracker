---
import { getCollection } from "astro:content";
import sitemap from "sitemap-ext:config";
import CardCover from "@/components/knowledge-card/CardCover.astro";
import KnowledgeCard from "@/components/knowledge-card/KnowledgeCard.astro";
import { SITE_TITLE } from "@/consts";
import sql from "@/lib/db"; // Panggil database kamu
import {
  createCardStyles,
  getTemplateKey,
} from "@/lib/utils";
import { KNOWLEDGE_CARD_THEME } from "@/themes/knowledge-card-themes";
import MainLayout from "../../layouts/MainLayout.astro";

// 1. Ambil ID dari URL (slug sekarang berfungsi sebagai ID)
const { slug } = Astro.params;

if (slug === undefined) {
  return new Response(null, { status: 400, statusText: "Bad Request" });
}

// 2. Ambil data dari database berdasarkan ID
const result = await sql`SELECT * FROM lokasi_wisata WHERE id = ${slug}`;
const tempat = result[0];

if (!tempat) {
  return Astro.redirect("/404");
}

// 3. Ambil data semua lokasi untuk navigasi Prev/Next & Rekomendasi
const allDestinations = await sql`SELECT id, dtw as title FROM lokasi_wisata ORDER BY id ASC`;

// 4. Logika Navigasi (Prev/Next)
const currentIndex = allDestinations.findIndex((d) => d.id.toString() === slug);
const prevCard = allDestinations[currentIndex - 1];
const nextCard = allDestinations[currentIndex + 1];

// 5. Metadata SEO
const cardTitle = tempat.dtw;
const cardDescription = tempat.deskripsi_lengkap || "Informasi lokasi wisata";
const origin = Astro.url.origin;
const currentTemplate = "blackWhite"; 
---

<MainLayout
  title={`${cardTitle} | ${SITE_TITLE}`}
  description={cardDescription}
>
  <div class="container mx-auto px-4 py-8 min-h-[80vh]">
    <div class="max-w-6xl mx-auto">
      <div class="mb-16 relative mx-auto" style="max-width:800px;">
        
        {prevCard && (
          <div class="xl:absolute xl:-left-65 xl:top-[66%] xl:-translate-y-1/2 xl:w-80 mx-auto opacity-60 hover:scale-105 transition-all">
            <a href={`/cards/${prevCard.id}`}>
              <CardCover title={prevCard.title} template={currentTemplate} size="small" />
            </a>
          </div>
        )}

        <div class="xl:relative xl:z-10">
          <KnowledgeCard
            articleData={{
              title: tempat.dtw,
              description: cardDescription,
              // Isi properti kosong agar tidak error TS
              keyPoints: [],
              references: [],
              tools: [],
              mermaidMarkdown: "",
            }}
            url={`${origin}/cards/${tempat.id}`}
            cardStyles={createCardStyles(getTemplateKey(currentTemplate))}
            cardTheme={KNOWLEDGE_CARD_THEME[getTemplateKey(currentTemplate)]}
            tags={[tempat.provinsi, tempat.kotakabupaten]}
            isFlipped={false}
          />
        </div>

        {nextCard && (
          <div class="xl:absolute xl:-right-65 xl:top-[66%] xl:-translate-y-1/2 xl:w-80 mx-auto opacity-60 hover:scale-105 transition-all">
            <a href={`/cards/${nextCard.id}`}>
              <CardCover title={nextCard.title} template={currentTemplate} size="small" />
            </a>
          </div>
        )}
      </div>
    </div>
  </div>
</MainLayout>