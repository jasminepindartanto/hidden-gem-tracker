---
import { SITE_TITLE } from "@/consts";
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout
  title={`Search | ${SITE_TITLE}`}
  description="Search through cards, blogs, and slides"
>
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-teahouse-dark mb-8">Search</h1>

      <div id="search-container">
        <!-- Pagefind search will be initialized here -->
      </div>

      <div class="mt-6 text-sm text-white">
        <p>
          Search through our collection of knowledge cards, blog articles, and
          presentation slides.
        </p>
        <p class="mt-2">
          Try searching for topics like "AI", "development", "deployment", or
          any technology you're interested in.
        </p>
      </div>
    </div>
  </div>
</MainLayout>

<script is:inline type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const pagefind = await import("/_pagefind/pagefind.js");
      await pagefind.init();

      const searchContainer = document.getElementById("search-container");
      if (!searchContainer) return;

      // 1. Inisialisasi Elemen UI
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "Cari destinasi, blog, atau kategori...";
      searchInput.className = "w-full px-4 py-3 text-lg bg-slate-800 border border-slate-700 text-white rounded-xl focus:ring-2 focus:ring-emerald-500 mb-4 outline-none";

      const resultsContainer = document.createElement("div");
      resultsContainer.id = "search-results";

      searchContainer.appendChild(searchInput);
      searchContainer.appendChild(resultsContainer);

      // 2. Fungsi Utama Pencarian
      const performSearch = async (query) => {
        if (!query || !query.trim()) {
          resultsContainer.innerHTML = "";
          return;
        }

        resultsContainer.innerHTML = '<div class="text-center py-8 text-slate-400 italic">Mencari...</div>';

        try {
          const search = await pagefind.search(query);
          if (search.results.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center py-8 text-slate-500">Tidak ada hasil ditemukan untuk "' + query + '"</div>';
            return;
          }

          const resultsHTML = await Promise.all(
            search.results.slice(0, 10).map(async (result) => {
              const data = await result.data();
              // Hapus akhiran .html untuk URL Astro yang bersih
              const cleanUrl = data.url.replace(/\.html$/, "").replace(/\/index$/, "");
              
              return `
                <div class="bg-slate-900/50 rounded-2xl border border-slate-800 p-6 hover:border-emerald-500/50 transition-all mb-4">
                  <h3 class="text-xl font-bold mb-2">
                    <a href="${cleanUrl}" class="text-white hover:text-emerald-400 transition-colors">
                      ${data.meta?.title || data.title}
                    </a>
                  </h3>
                  <div class="text-slate-400 text-sm mb-3 line-clamp-2">
                    ${data.excerpt}
                  </div>
                  <a href="${cleanUrl}" class="text-xs font-bold text-emerald-500 uppercase tracking-widest">Lihat Detail â†’</a>
                </div>
              `;
            })
          );

          resultsContainer.innerHTML = `
            <div class="mb-4 text-xs text-slate-500 uppercase tracking-widest">
              Ditemukan ${search.results.length} hasil
            </div>
            ${resultsHTML.join("")}
          `;
        } catch (e) {
          console.error(e);
        }
      };

      // 3. Menangani Input Real-time
      let debounceTimeout;
      searchInput.addEventListener("input", (e) => {
        const query = e.target.value;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          // Update URL tanpa reload agar sinkron saat user mengetik
          const newUrl = query ? `?q=${encodeURIComponent(query)}` : window.location.pathname;
          window.history.replaceState(null, "", newUrl);
          performSearch(query);
        }, 300);
      });

      // 4. TRIGGER OTOMATIS SAAT HALAMAN DIBUKA (Penting untuk Header Search)
      const urlParams = new URLSearchParams(window.location.search);
      const initialQuery = urlParams.get("q");
      if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
      }

    } catch (error) {
      console.error("Pagefind load failed:", error);
    }
  });
</script>