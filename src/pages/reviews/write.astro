---
import sql from "@/lib/db"; // Gunakan koneksi database Anda
import MainLayout from "./../../layouts/MainLayout.astro";

const sessionId = Astro.cookies.get("session")?.value;
let currentUser = null;

if (sessionId) {
  // 2. Cari nama user di database berdasarkan session ID
  const users =
    await sql`SELECT display_name FROM users WHERE id::text = ${sessionId} LIMIT 1`;
  if (users.length > 0) {
    currentUser = users[0];
  }
}

if (!currentUser) {
  return Astro.redirect(
    "/auth/login?error=unauthorized&message=Silakan login terlebih dahulu untuk menulis ulasan",
  );
}

const preSelectedId = Astro.url.searchParams.get("lokasi_id"); // Tangkap ID dari tombol
const allDestinations =
  await sql`SELECT id, dtw FROM lokasi_wisata ORDER BY dtw ASC`;
---

<MainLayout title="Write a Review" description="berikan ulasan terbaru dari komunitas Hidden Bandung.">
  <div class="px-6 md:px-16 max-w-7xl mx-auto py-12">
    <header class="mb-12 text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold font-noto-serif
                text-slate-800 tracking-tight">
        Share Your Experience
      </h1>

      <p class="mt-3 text-slate-600 text-base md:text-lg 
                max-w-2xl mx-auto leading-relaxed">
        Tell the community about your latest discovery in Bandung.
      </p>

      <div class="mt-5 mx-auto w-28 h-[3px] rounded-full 
                  bg-gradient-to-r from-emerald-400 via-amber-400 to-cyan-400">
      </div>
    </header>



   <form 
      action="/api/ulasan" 
      method="POST" 
      class="bg-white/70 border border-slate-200/70
            p-8 md:p-12 rounded-[48px]
            backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.12)]"
    >

     <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">

  <!-- LEFT SIDE -->
  <div class="space-y-8">

    <!-- DESTINATION -->
    <div class="space-y-3">
      <label class="text-sm font-semibold text-slate-700 ml-1">
        Where did you go?
      </label>

      <select 
        name="lokasi_id" 
        required
        class="w-full bg-white/90 border border-slate-300 rounded-2xl px-5 py-4
               text-slate-800 outline-none
               focus:border-emerald-400 focus:ring-2 focus:ring-emerald-200
               transition-all">

        <option value="" disabled selected={!preSelectedId} class="text-slate-400">
          Select a destination
        </option>

        {allDestinations.map((dest: any) => (
          <option 
            value={dest.id} 
            selected={preSelectedId === dest.id.toString()}>
            {dest.dtw}
          </option>
        ))}
      </select>
    </div>

    <!-- RATING -->
    <div class="space-y-4 p-6 bg-emerald-50/70 rounded-3xl border border-emerald-200 text-center shadow-sm">
      <label class="text-sm font-semibold text-slate-700">
        Rate your visit
      </label>

      <div class="flex justify-center gap-4 text-4xl" id="star-rating">
        {[1, 2, 3, 4, 5].map(star => (
          <button 
            type="button" 
            data-value={star}
            class="star-btn text-slate-300 hover:text-amber-400 hover:scale-110 transition-all">
            â˜…
          </button>
        ))}
      </div>

      <input type="hidden" name="rating" id="rating-input" value="0" required />
    </div>

    <!-- USER NAME -->
    <div class="space-y-2">
      <label class="text-sm font-semibold text-slate-700 ml-1">
        Your Name
      </label>

      <input 
        name="nama_user" 
        type="text" 
        required 
        readonly
        value={currentUser.display_name}
        class="w-full bg-slate-100 border border-slate-300 rounded-2xl px-5 py-4
               text-slate-700 outline-none cursor-not-allowed"
      />

      <p class="text-[11px] text-slate-500 ml-1 italic">
        *Posting as logged in user
      </p>
    </div>

    <input type="hidden" name="user_id" value={sessionId} />

  </div>


  <!-- RIGHT SIDE -->
  <div class="space-y-8">

    <div class="space-y-3">
      <label class="text-sm font-semibold text-slate-700 ml-1">
        Your Review
      </label>

      <textarea 
        name="komentar" 
        rows="6" 
        required 
        placeholder="What made this place special?"
        class="w-full bg-white/90 border border-slate-300 rounded-2xl px-5 py-4
               text-slate-800 outline-none resize-none
               focus:border-emerald-400 focus:ring-2 focus:ring-emerald-200
               placeholder:text-slate-400 transition-all">
      </textarea>
    </div>

  </div>

</div>


      <div class="flex flex-col md:flex-row-reverse gap-6 mt-16 pt-10 border-t border-slate-700">
        <button type="submit" class="md:w-56 py-4 bg-emerald-500 text-slate-950 rounded-2xl font-bold transition-all shadow-lg active:scale-95">
          Submit Review
        </button>
        <a href="/reviews" class="md:w-32 py-4 text-center text-slate-400 font-bold text-sm uppercase">Cancel</a>
      </div>
    </form>

    <div class="mt-8 bg-emerald-500/5 border border-emerald-500/10 rounded-3xl p-6 flex gap-4 max-w-3xl mx-auto">
      <div class="text-emerald-500 shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
      </div>
      <p class="text-slate-400 text-xs leading-relaxed">
        <strong class="text-emerald-400 block mb-1">Writing a great review:</strong> 
        Fokus pada aksesibilitas, waktu terbaik berkunjung, dan tips lokal. Foto pintu masuk atau penanda jalan sangat membantu komunitas!
      </p>
    </div>
  </div>
</MainLayout>

<script is:inline>
  const stars = document.querySelectorAll('.star-btn');
  const ratingInput = document.getElementById('rating-input');

  stars.forEach(star => {
    star.addEventListener('click', () => {
      const val = parseInt(star.getAttribute('data-value'));
      ratingInput.value = val;
      stars.forEach((s, index) => {
        if (index < val) {
          s.classList.add('text-emerald-400');
          s.classList.remove('text-slate-700');
        } else {
          s.classList.remove('text-emerald-400');
          s.classList.add('text-slate-700');
        }
      });
    });
  });
</script>