---
import MainLayout from "./../../layouts/MainLayout.astro";
import sql from "@/lib/db"; // Gunakan koneksi database Anda

// Ambil destinasi dari DB agar lokasi_id sesuai dengan tabel lokasi_wisata
const allDestinations = await sql`SELECT id, dtw FROM lokasi_wisata ORDER BY dtw ASC`;

---

<MainLayout title="Write a Review" description="berikan ulasan terbaru dari komunitas Hidden Bandung.">
  <div class="px-6 md:px-16 max-w-7xl mx-auto py-12">
    <header class="mb-10">
      <h1 class="text-4xl font-bold text-white mb-2 font-noto-serif">Share Your Experience</h1>
      <p class="text-slate-400">Tell the community about your latest discovery in Bandung.</p>
    </header>

    <form 
      action="/api/ulasan" 
      method="POST" 
      class="bg-slate-900/50 border border-slate-700 p-8 md:p-12 rounded-[48px] backdrop-blur-md shadow-2xl"
    >
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
        <div class="space-y-8">
          <div class="space-y-4">
            <label class="text-sm font-bold text-slate-300 ml-1">Where did you go?</label>
            <select name="lokasi_id" required class="w-full bg-slate-800 border border-slate-600 rounded-2xl px-5 py-4 text-white outline-none appearance-none cursor-pointer transition-all">
              <option value="" disabled selected>Select a destination</option>
              {allDestinations.map(dest => <option value={dest.id}>{dest.dtw}</option>)}
            </select>
          </div>

          <div class="space-y-4 p-6 bg-slate-800/40 rounded-3xl border border-slate-700/50 text-center">
            <label class="text-sm font-bold text-slate-300">Rate your visit</label>
            <div class="flex justify-center gap-4 text-4xl" id="star-rating">
              {[1, 2, 3, 4, 5].map(star => (
                <button type="button" data-value={star} class="star-btn text-slate-700 hover:scale-110 transition-all">â˜…</button>
              ))}
            </div>
            <input type="hidden" name="rating" id="rating-input" value="0" required />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 ml-1">Your Name</label>
            <input 
              name="nama_user" 
              type="text" 
              required 
              placeholder="Ex: Cindy Nur" 
              class="w-full bg-slate-800 border border-slate-600 rounded-2xl px-5 py-4 text-white outline-none" 
            />
          </div>
        </div>

        <div class="space-y-8">
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 ml-1">Your Review</label>
            <textarea 
              name="komentar" 
              rows="6" 
              required 
              placeholder="What made this place special?" 
              class="w-full bg-slate-800 border border-slate-600 rounded-2xl px-5 py-4 text-white outline-none resize-none"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row-reverse gap-6 mt-16 pt-10 border-t border-slate-800">
        <button type="submit" class="md:w-56 py-4 bg-emerald-500 text-slate-950 rounded-2xl font-bold transition-all shadow-lg active:scale-95">
          Submit Review
        </button>
        <a href="/reviews" class="md:w-32 py-4 text-center text-slate-400 font-bold text-sm uppercase">Cancel</a>
      </div>
    </form>

    <div class="mt-8 bg-emerald-500/5 border border-emerald-500/10 rounded-3xl p-6 flex gap-4 max-w-3xl mx-auto">
      <div class="text-emerald-500 shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
      </div>
      <p class="text-slate-400 text-xs leading-relaxed">
        <strong class="text-emerald-400 block mb-1">Writing a great review:</strong> 
        Fokus pada aksesibilitas, waktu terbaik berkunjung, dan tips lokal. Foto pintu masuk atau penanda jalan sangat membantu komunitas!
      </p>
    </div>
  </div>
</MainLayout>

<script is:inline>
  const stars = document.querySelectorAll('.star-btn');
  const ratingInput = document.getElementById('rating-input');

  stars.forEach(star => {
    star.addEventListener('click', () => {
      const val = parseInt(star.getAttribute('data-value'));
      ratingInput.value = val;
      stars.forEach((s, index) => {
        if (index < val) {
          s.classList.add('text-emerald-400');
          s.classList.remove('text-slate-700');
        } else {
          s.classList.remove('text-emerald-400');
          s.classList.add('text-slate-700');
        }
      });
    });
  });
</script>