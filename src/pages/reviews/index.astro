---
import sql from "@/lib/db";
import RatingSummary from "../../components/RatingSummary.astro";
import ReviewCard from "../../components/ReviewCard.astro";
import MainLayout from "./../../layouts/MainLayout.astro";

// 1. Ambil data dari tabel 'ulasan' dan gabungkan dengan 'lokasi_wisata'
const result = await sql`
  SELECT 
    u.id,
    u.nama_user as author, 
    u.rating, 
    u.komentar as body, 
    u.tanggal as pubDate,
    l.dtw as location,
    l.id as locationId
  FROM ulasan u 
  LEFT JOIN lokasi_wisata l ON u.lokasi_id = l.id 
  ORDER BY u.tanggal DESC
`;

// 2. Map data dengan proteksi terhadap nilai 'undefined' atau 'null'
const sortedReviews = result.map((rev) => {
  const parsedDate = rev.pubDate ? new Date(rev.pubDate) : new Date();

  return {
    id: rev.id,
    data: {
      userName: rev.author || "Explorer",
      rating: Number(rev.rating) || 0,
      location: rev.location || "Destinasi",
      content: rev.body || "",
      pubDate: isNaN(parsedDate.getTime()) ? new Date() : parsedDate,
      images: [],
    },
  };
});
---

<MainLayout 
  title="Community Stories" 
  description="Baca ulasan terbaru dari komunitas Hidden Bandung."
>
  <div class="px-4 md:px-12 max-w-5xl mx-auto py-16 bg-slate-950/70 backdrop-blur-xl border border-slate-800 rounded-[40px] shadow-2xl">
    <header class="mb-12">
      <h1 class="text-5xl md:text-6xl font-noto-serif font-bold text-emerald-400 tracking-tight mb-3">
        Community Stories
      </h1>

      <p class="text-slate-400 text-base">Discover Bandung through the eyes of our fellow travelers.</p>
    </header>

    <RatingSummary allReviews={sortedReviews} />

    <div class="flex justify-between items-center mb-10">
      <h2 class="text-xl font-bold text-white">Recent Experience</h2>
      <a 
        href="/reviews/write" 
        class="bg-emerald-500 text-slate-950 px-8 py-3 rounded-full font-black text-sm uppercase tracking-widest hover:bg-emerald-400 transition-all shadow-[0_0_20px_rgba(16,185,129,0.35)] border border-emerald-400"
      >
        ‚úç Write a Review
      </a>

    </div>

    <div class="space-y-6">
      {sortedReviews.length > 0 ? (
        sortedReviews.map(review => (
        <div>
        <ReviewCard review={review.data} />
      </div>

    
        ))
      ) : (
        <div class="text-center py-20">Belum ada ulasan.</div>
          )
      }
    </div>
  </div>
</MainLayout>
