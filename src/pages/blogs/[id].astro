---
import FormattedDate from "@/components/FormattedDate.astro";
import LocationSidebar from "@/components/LocationSidebar.astro";
import ContentNavigation from "@/components/navigation/ContentNavigation.astro";
import { SITE_TITLE } from "@/consts";
import MainLayout from "@/layouts/MainLayout.astro";
import sql from "@/lib/db";

const { id } = Astro.params;

// 1. Proteksi jika ID tidak ada
if (!id) return Astro.redirect("/404");

// 2. Ambil data utama destinasi dari database
const result = await sql`SELECT * FROM lokasi_wisata WHERE id = ${id}`;

const [post] = await sql`
SELECT 
  l.*,

  ROUND(AVG(u.rating)::numeric, 1) AS rating,
  COUNT(u.id) AS total_reviews

FROM lokasi_wisata l
LEFT JOIN ulasan u ON u.lokasi_id = l.id
WHERE l.id = ${id}
GROUP BY l.id
`;

if (!post) return Astro.redirect("/404");

// 3. Ambil data ulasan terkait
const ulasanData =
  await sql`SELECT * FROM ulasan WHERE lokasi_id = ${id} ORDER BY tanggal DESC`;

// 4. Logika Navigasi (Mencari konten sebelum & sesudah)
const allDestinations =
  await sql`SELECT id, dtw FROM lokasi_wisata ORDER BY id ASC`;
const currentIndex = allDestinations.findIndex((d) => d.id === post.id);

const adjacentContent = {
  previous: allDestinations[currentIndex - 1] || null, // Gunakan 'previous'
  next: allDestinations[currentIndex + 1] || null,
};

const origin = Astro.url.origin;
---

<MainLayout 
  title={`${post.dtw} | ${SITE_TITLE}`} 
  description={post.deskripsi_lengkap?.substring(0, 160)}
  type="article"
  author={post.author || "Admin"}
  publishedTime={new Date(post.tanggal).toISOString()}
>
  <article class="container mx-auto px-4 py-8">
    <div class="max-w-screen-lg mx-auto p-4">
      <div class="mb-4 py-4 text-center">
        <h1 class="text-4xl md:text-6xl font-serif font-extrabold mb-4
                  text-slate-800
                  drop-shadow-[0_2px_12px_rgba(255,255,255,0.65)]">
          {post.dtw}
        </h1>

        <div class="text-slate-600 mb-6 font-medium">
          <FormattedDate date={new Date(post.tanggal)} />
          <span class="mx-2">•</span>
          <span>Oleh {post.author || "Admin"}</span>
        </div>
        
        <div class="flex items-center justify-between py-4 border-y border-slate-800">
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/80 backdrop-blur shadow-md border border-amber-200 text-amber-600 font-semibold text-sm">
            <span>⭐</span>
            <span>{post.rating ?? 0}</span>

            {post.total_reviews > 0 && (
              <span class="text-slate-500 text-xs">
                ({post.total_reviews} ulasan)
              </span>
            )}
          </div>

         
        </div>
      </div>
    </div>

    {post.url_foto && (
      <img 
        src={post.url_foto} 
        alt={post.dtw} 
        class="w-full max-h-[550px] object-cover rounded-[40px] mb-12 shadow-2xl" 
      />
    )}
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 max-w-screen-xl mx-auto">
      <div class="lg:col-span-2">
       <div class="prose max-w-none
            text-slate-800
            text-[1.08rem]
            leading-8
            font-medium
            whitespace-pre-line">

          {post.deskripsi_lengkap}
        </div>

        <div class="mt-20 pt-10 border-t border-slate-800">
          <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold text-slate-800 font-noto-serif">Cerita Pengunjung</h3>
            
            {/* Tombol Tulis Ulasan yang Otomatis Membawa ID Destinasi */}
            <a 
              href={`/reviews/write?lokasi_id=${post.id}`} 
              class="bg-emerald-500 hover:bg-emerald-600 text-slate-950 px-5 py-2.5 rounded-2xl text-xs font-bold transition-all shadow-lg shadow-emerald-500/20 active:scale-95 flex items-center gap-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Tulis Ulasan
            </a>
          </div>

          <div class="space-y-6">
            {ulasanData.length > 0 ? ulasanData.map((rev) => (
              <div class="bg-white/60 backdrop-blur-lg
              p-6 rounded-3xl
              border border-white/60
              shadow-xl shadow-rose-200/40">
                <div class="flex justify-between items-center mb-3">
                  <span class="font-bold text-slate-800">{rev.nama_user}</span>
                  {/* Gunakan rating_user sesuai skema database Anda */}
                  <div class="text-amber-500 text-sm">{"★".repeat(rev.rating || 0)}</div>
                </div>
                <p class="text-slate-600 italic text-sm">"{rev.komentar || "Sangat direkomendasikan!"}"</p>
              </div>
            )) : (
              <div class="text-center py-10 bg-slate-900/20 rounded-3xl border border-dashed border-slate-800">
                <p class="text-slate-500 italic">Belum ada ulasan. Jadilah yang pertama berbagi cerita di sini.</p>
              </div>
            )}
          </div>
        </div>

        <div class="mt-16">
          <ContentNavigation adjacentContent={adjacentContent} contentType="blogs" />
        </div>
      </div>

      <aside class="space-y-8">
        <div class="sticky top-24 space-y-8">
          <LocationSidebar post={post} /> 
        </div>
      </aside>
    </div>
  </article>
</MainLayout>