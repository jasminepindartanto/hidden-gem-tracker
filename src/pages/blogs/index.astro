---
import MainLayout from "../../layouts/MainLayout.astro";
import BlogCard from "@/components/blog/BlogCard.astro";
import sql from "@/lib/db";
import { Search } from "lucide-react"; // Opsional: Tambahkan ikon search

const currentStartId = Astro.url.searchParams.get("start") || "";
const searchQuery = Astro.url.searchParams.get("q")?.toLowerCase() || ""; // Ambil query pencarian

const destinationsResult = await sql`SELECT * FROM lokasi_wisata`;
const titikAwal = await sql`SELECT * FROM titik_awal ORDER BY nama_lokasi ASC`;

const selectedPoint = titikAwal.find(p => p.id.toString() === currentStartId);

function calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number) {
  const R = 6371; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Filter dan Map Data dalam satu langkah
let allDestinations = destinationsResult
  .filter((item) => item.dtw.toLowerCase().includes(searchQuery)) // Filter berdasarkan nama
  .map((item) => {
    let distance = 0;
    if (selectedPoint) {
      distance = calculateDistance(
        Number(selectedPoint.latitude), 
        Number(selectedPoint.longitude), 
        Number(item.latitude), 
        Number(item.longitude)
      );
    }
    return {
      ...item,
      id: item.id.toString(),
      title: item.dtw,
      distance: distance,
      rating: Number(item.rating) || 0, 
      pubDate: new Date(item.tanggal)
    };
  });

if (currentStartId) {
  allDestinations.sort((a, b) => a.distance - b.distance);
}
---

<MainLayout title="Destinasi Wisata" description="Cari dan temukan destinasi wisata terdekat di Bandung">
  <div class="container mx-auto px-4 py-8">
    
    <div class="mb-12 flex flex-col md:flex-row items-center justify-center gap-4">
      <form method="GET" class="flex flex-col md:flex-row items-center gap-3 w-full max-w-3xl">
        
        <div class="relative flex-grow w-full">
          <input 
            type="text" 
            name="q" 
            value={searchQuery}
            placeholder="Cari nama tempat..." 
            class="w-full bg-slate-900 border border-slate-700 text-white px-5 py-3 rounded-2xl outline-none focus:border-emerald-500 tracking-tight transition-all"
          />
        </div>

        <select 
          name="start" 
          onchange="this.form.submit()" 
          class="w-full md:w-auto bg-slate-900 border border-slate-700 text-white px-5 py-3 rounded-2xl outline-none focus:border-emerald-500 tracking-tight cursor-pointer transition-all"
        >
          <option value="">-- Lokasi Terdekat --</option>
          {titikAwal.map((point) => (
            <option value={point.id} selected={currentStartId === point.id.toString()}>
              {point.nama_lokasi}
            </option>
          ))}
        </select>

        <button type="submit" class="hidden">Cari</button>
        
        {(searchQuery || currentStartId) && (
          <a href={Astro.url.pathname} class="text-emerald-500 font-bold text-sm hover:underline tracking-tight">
            Reset
          </a>
        )}
      </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {allDestinations.length > 0 ? (
        allDestinations.map((post) => (
          <div class="relative group">
            {currentStartId && (
              <div class="absolute top-4 left-4 z-10 bg-emerald-500 text-slate-950 px-3 py-1 rounded-full text-[10px] font-bold tracking-tight shadow-lg">
                {post.distance.toFixed(1)} KM
              </div>
            )}
            <BlogCard blog={post} />
          </div>
        ))
      ) : (
        <div class="col-span-full text-center py-20">
          <p class="text-slate-500 text-lg">Tidak ada destinasi yang cocok dengan pencarian Anda.</p>
        </div>
      )}
    </div>
  </div>
</MainLayout>