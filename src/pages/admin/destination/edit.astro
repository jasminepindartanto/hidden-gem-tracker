---
// src/pages/admin/destinations/edit.astro
import AdminLayout from "@/layouts/AdminLayout.astro";
import DestinationForm from "@/components/admin/DestinationForm.astro";
import sql from "@/lib/db";

// 1. Ambil ID dari URL
const id = Astro.url.searchParams.get("id");

// 2. LOGIKA UPDATE (Hanya jalan saat tombol Simpan diklik)
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    
    const tagsRaw = data.get("tags")?.toString() || "";
    const tagsArray = tagsRaw.split(",").map(t => t.trim()).filter(t => t !== "");

    await sql`
      UPDATE lokasi_wisata SET
        dtw = ${data.get("dtw")?.toString() || ""},
        kategori_akses = ${data.get("kategori_akses")?.toString() || 'non-hidden'},
        tags = ${tagsArray}, 
        rating = ${parseFloat(data.get("rating")?.toString() || "0")},
        lokasi = ${data.get("lokasi")?.toString() || ""},
        latitude = ${parseFloat(data.get("latitude")?.toString() || "0")},
        longitude = ${parseFloat(data.get("longitude")?.toString() || "0")},
        deskripsi_lengkap = ${data.get("deskripsi_lengkap")?.toString() || ""},
        url_foto = ${data.get("url_foto")?.toString() || ""}
      WHERE id = ${id}
    `;

    return Astro.redirect("/admin/destination", 303);
  } catch (error) {
    console.error("Gagal update database:", error);
  }
}

// 3. AMBIL DATA AWAL (Untuk mengisi form saat halaman dibuka)
let destinationData = null;
if (id) {
  const result = await sql`
    SELECT * FROM lokasi_wisata WHERE id = ${id}
  `;
  destinationData = result[0];
}

// Redirect jika data tidak ditemukan
if (!destinationData) return Astro.redirect("/admin/destination");
---

<AdminLayout title="Edit Destination" description="Perbarui informasi tempat wisata">
  <main class="max-w-4xl mx-auto px-4 py-16">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-bold text-slate-900 font-noto-serif">Edit Destination</h1>
      <p class="mt-2 text-slate-500">Ubah detail untuk {destinationData.dtw}</p>
    </header>

    <div class="bg-white p-8 md:p-12 rounded-[40px] border border-slate-100 shadow-xl">
      {/* Pastikan initialData diteruskan dengan benar */}
      <DestinationForm mode="edit" initialData={destinationData} />
    </div>
  </main>
</AdminLayout>