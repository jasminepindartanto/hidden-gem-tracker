---
import { getCollection } from "astro:content";
import BlogCard from "@/components/blog/BlogCard.astro";
import CardCover from "@/components/knowledge-card/CardCover.astro";
import HeroSection from "@/components/landing-page/HeroSection.astro";
import LatestSection from "@/components/landing-page/LatestSection.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "@/consts";
import MainLayout from "@/layouts/MainLayout.astro";
import sql from "@/lib/db";

// 1. Ambil data DESTINASI dari DATABASE
const dbResult = await sql`SELECT * FROM lokasi_wisata ORDER BY tanggal DESC LIMIT 3`;

const posts = dbResult.map((item) => ({
  id: item.id.toString(),
  title: item.dtw,
  rating: Number(item.rating),
  location: item.lokasi,
  description: item.deskripsi_lengkap?.substring(0, 100) + "...", 
  image: item.url_foto,
  pubDate: new Date(item.tanggal),
  author: item.author || "Admin",
  tags: item.tags || []
}));

// 2. LOGIKA NEAR YOU: Menghitung jarak dari Coblong (-6.8844, 107.6135)
const nearYouResult = await sql`
  SELECT *, 
  (6371 * acos(cos(radians(-6.8844)) * cos(radians(latitude)) * cos(radians(longitude) - radians(107.6135)) + sin(radians(-6.8844)) * sin(radians(latitude)))) AS jarak
  FROM lokasi_wisata 
  ORDER BY jarak ASC 
  LIMIT 4
`;

const recentReviews = await sql`
  SELECT 
    u.nama_user, 
    u.rating, 
    u.komentar, 
    l.dtw as nama_lokasi 
  FROM ulasan u 
  LEFT JOIN lokasi_wisata l ON u.lokasi_id = l.id 
  ORDER BY u.tanggal DESC
  LIMIT 3
`;

// 2. Ambil data CARDS & SLIDES (Masih Statis dari Content Collection)
const allCards = (await getCollection("cards"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map((card) => ({
    id: card.id,
    title: card.data.title,
    template: card.data.template,
    tags: card.data.tags,
  }));
  

const allSlides = (await getCollection("slides"))
  .filter((slide) => slide.data.pubDate)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map((slide) => ({
    id: slide.id,
    title: slide.data.title,
    description: slide.data.description,
    author: slide.data.author,
    pubDate: slide.data.pubDate,
    tags: slide.data.tags,
  }));

// 3. Gabungkan semua Tags untuk Hero Search
const allTags = [
  ...posts.flatMap((post) => post.tags || []),
  ...allCards.flatMap((card) => card.tags || []),
  ...allSlides.flatMap((slide) => slide.tags || []),
];
const uniqueTags = [...new Set(allTags)];

const cards = allCards.slice(0, 6);

// 4. Ambil Active Doodle
const now = new Date();
const activeDoodleEntry = (await getCollection("doodles"))
  .filter((doodle) => doodle.data.pubDate <= now && doodle.data.endDate >= now)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())[0];

const activeDoodle = activeDoodleEntry
  ? { ...activeDoodleEntry.data, href: `/doodles/${activeDoodleEntry.id}` }
  : undefined;

const sessionId = Astro.cookies.get("session")?.value;
const isLoggedIn = !!sessionId;
---

<MainLayout
  title={`Home | ${SITE_TITLE}`}
  description={SITE_DESCRIPTION}
  className="w-full p-0"
>
  <HeroSection uniqueTags={uniqueTags} doodle={activeDoodle} isLoggedIn={isLoggedIn}/>

  <div class="px-4 md:px-8 lg:px-12 max-w-7xl mx-auto">
    
    <LatestSection
      title="Curated For You"
      accentColor="text-nebula"
      description="Hand-picked destinations for your weekend getaway."
      viewAllHref="/blogs"
      viewAllText="View All Destinations"
      viewAllButtonWidth="165px"
    >
      {posts.map((blog) => <BlogCard blog={blog} />)}
    </LatestSection>

    <section class="mt-16 mb-24">
      <div class="mb-10">
        <h2 class="text-3xl font-bold text-white mb-2">Near You</h2>
        <p class="text-slate-400 text-sm">Based on your current location in Coblong.</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-16">
        {nearYouResult.map((item) => (
          <a href={`/blogs/${item.id}`} class="flex items-center gap-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group">
            <div class="w-16 h-16 rounded-xl bg-slate-200 overflow-hidden flex-shrink-0">
              <img 
                src={item.url_foto} 
                alt={item.dtw} 
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" 
              />
            </div>
            <div class="overflow-hidden">
              <h4 class="font-bold text-slate-800 text-sm truncate">{item.dtw}</h4>
              <p class="text-[11px] text-slate-500 mt-0.5">
                {item.jarak.toFixed(1)} km away • {(item.lokasi || "").split(',')[0]}
              </p>
              <div class="flex items-center gap-1 mt-1.5">
                <span class="text-yellow-400 text-[11px]">⭐</span>
                <span class="text-[11px] font-bold text-slate-700">{Number(item.rating).toFixed(1)}</span>
              </div>
            </div>
          </a>
        ))}
      </div>

      <div class="relative overflow-hidden rounded-[40px] bg-[#2D4A3E] p-12 md:p-20 text-center shadow-2xl">
        <div class="absolute inset-0 bg-gradient-to-tr from-emerald-500/10 to-transparent opacity-40"></div>
        <div class="relative z-10 flex flex-col items-center">
          <h2 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight">Explore the Interactive Map</h2>
          <a href="/travelmap" class="flex items-center gap-3 bg-white text-[#2D4A3E] px-10 py-4.5 rounded-full font-bold shadow-xl hover:bg-emerald-50 transition-all transform hover:scale-105 active:scale-95">
            Open Interactive Map
          </a>
        </div>
      </div>
    </section>

    <section class="mt-24 mb-24">
      <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-10">
        <h2 class="text-3xl font-bold text-white mb-2 font-noto-serif">Recent Community Reviews</h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {recentReviews.map((rev) => (
          <div class="bg-white p-8 rounded-[32px] shadow-sm hover:shadow-md transition-all border border-slate-100 flex flex-col justify-between">
            <div>
              <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 rounded-full bg-[#1e2f28] flex items-center justify-center font-bold text-emerald-100 text-sm uppercase">
                  {rev.nama_user.substring(0, 2)}
                </div>
                <div>
                  <p class="text-slate-900 font-bold text-sm leading-none mb-1">{rev.nama_user}</p>
                  <p class="text-slate-500 text-[11px]">Reviewing: <span class="font-medium text-slate-700">{rev.nama_lokasi}</span></p>
                </div>
              </div>
              
              <div class="flex gap-1 mb-4">
                {[...Array(5)].map((_, i) => (
                  <span class={`text-[12px] ${i < rev.rating ? 'text-yellow-400' : 'text-slate-200'}`}>
                    ★
                  </span>
                ))}
              </div>

              <p class="text-slate-600 text-sm italic leading-relaxed">
                "{rev.komentar}"
              </p>
            </div>
          </div>
        ))}
      </div>
    </section>
  </div>
</MainLayout>