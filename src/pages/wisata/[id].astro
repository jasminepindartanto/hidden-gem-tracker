---
// src/pages/wisata/[id].astro
import MainLayout from "../../layouts/MainLayout.astro";
import KnowledgeCard from "@/components/knowledge-card/KnowledgeCard.astro";
import { SITE_TITLE } from "@/consts";
import sql from "../../lib/db"; // Import koneksi database kamu
import { createCardStyles, getTemplateKey } from "@/lib/utils";
import { KNOWLEDGE_CARD_THEME } from "@/themes/knowledge-card-themes";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/404");
}

const result = await sql`SELECT * FROM lokasi_wisata WHERE id = ${id}`;
const tempat = result[0];

if (!tempat) {
  return Astro.redirect("/404");
}

// 2. Ambil semua kartu untuk navigasi rekomendasi (opsional)
const allCards = await sql`SELECT id, dtw as title FROM lokasi_wisata ORDER BY id DESC`;

// 3. Metadata untuk SEO
const cardTitle = tempat.dtw;
const cardDescription = tempat.deskripsi_lengkap || "Informasi lokasi wisata";
const origin = Astro.url.origin;

// Sesuaikan template warna (default 'blackWhite' jika null)
const currentTemplate = "blackWhite"; 
---

<MainLayout
  title={`${cardTitle} | ${SITE_TITLE}`}
  description={cardDescription}
>
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <div class="mb-16 relative mx-auto" style="max-width:800px;">
        
        <div class="xl:relative xl:z-10">
          <KnowledgeCard
            articleData={{
                title: tempat.dtw,
                description: tempat.deskripsi_lengkap || "",
                // Tambahkan properti kosong di bawah ini agar error ts(2739) hilang
                keyPoints: [],
                references: [],
                tools: [],
                mermaidMarkdown: "",
            }}
            url={`${origin}/wisata/${tempat.id}`}
            cardStyles={createCardStyles(getTemplateKey(currentTemplate))}
            cardTheme={KNOWLEDGE_CARD_THEME[getTemplateKey(currentTemplate)]}
            tags={[tempat.provinsi, tempat.kotakabupaten]}
            isFlipped={false}
          />
        </div>

      </div>
      
      <div class="mt-16">
        <h2 class="text-2xl font-bold mb-6 text-center">Related Destinations</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {allCards.slice(0, 4).map((item) => (
            <a href={`/wisata/${item.id}`}>
               <div class="border p-4 rounded-lg shadow">{item.title}</div>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</MainLayout>